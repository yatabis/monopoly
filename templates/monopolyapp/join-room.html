{% extends 'monopolyapp/liff-base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
  <script>
      const fetchGet = (ep) => {
          // fetch(ep).then(response => response.json()).then(text => {return text})
          let req = new XMLHttpRequest();
          req.open("GET", ep);
          req.responseType = "json";
          req.send();
          req.onload = () => {
              return req.response;
          }
      };

      const fetchPost = (ep, body) => {
          // fetch(ep, {method: "POST", body: JSON.stringify(body)}).then(response => response.json()).then(text => {return text})
          let req = new XMLHttpRequest();
          req.open("POST", ep);
          req.responseType = "json";
          req.send(JSON.stringify(body));
          req.onload = () => {
              return req.response;
          }
      };

      const pushLINE = (to, text) => {
          const ep = "https://api.line.me/v2/bot/message/push";
          /* fetch(ep, {
              method: "POST",
              headers: JSON.stringify({/{ header }}),
              body: JSON.stringify({'type': 'text', 'text': text})
          }).then(response => response.status).then(text => {return text}) */
          let req = new XMLHttpRequest();
          req.open("POST", ep);
          req.responseType = "json";
          req.setRequestHeader(JSON.stringify({{ header }}));
          req.send(JSON.stringify({'type': 'text', 'text': text}));
          req.onload = () => {
              return req.response;
          }
      };

      liff.init(data=>{
          const lineId = data.context.userId;
          const lineName = data.context.displayName;
          const player = fetchGet("https://monopolyapp.herokuapp.com/api/players?line_id=" + lineId);
          if ((Object.keys(player).length === 1) || (player.room_id === "")) {
              fetchPost("http://monopolyapp.herokuapp.com/api/players",
                  {
                      'line_id': lineId,
                      'line_name': lineName,
                      'room_id': {{ room_id }}
                  });
              pushLINE(lineId, "ルーム" + {{ room_id|slice:":6" }} + "に入室しました。")
          } else {
              pushLINE(lineId, "予期せぬエラーが発生しました。")
          }
          liff.closeWindow();
      },err=>{});
  </script>

{% endblock %}
