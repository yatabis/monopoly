{% extends 'monopolyapp/liff-base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
  <p id="message"></p>
  <script>
      const pushLINE = (to, text) => {
          const ep = "https://api.line.me/v2/bot/message/push";
          fetch(ep, {
              method: "POST",
              headers: {'Authorization': 'Bearer {{ header }}'},
              body: JSON.stringify({'to': to, 'messages': [{'type': 'text', 'text': text}]})
          }).then(response => response.status)
      };

      const register = (lineId, lineName) => {
          document.getElementById('message').innerText += lineName;
          alert(lineName);
          pushLINE(lineId, 'lineName: ' + lineName);
          const ep = "http://monopolyapp.herokuapp.com/api/players?format=json";
          const body = {'line_id': lineId, 'line_name': lineName, 'room_id': {{ room_id }}};
          fetch(ep, {method: "POST", body: JSON.stringify(body)}).then(res => res.status);
          pushLINE(lineId, "ルーム" + {{ room_id|slice:":6" }} + "に入室しました。");
      };

      const loginPlayer = (lineId, player) => {
          document.getElementById('message').innerText += JSON.stringify(player);
          alert(JSON.stringify(player));
          pushLINE(lineId, JSON.stringify(player));
          if ((Object.keys(player).length === 1) || (player.room_id === "")) {
              alert(player.room_id);
              document.getElementById('message').innerText += Object.keys(player).length;
              document.getElementById('message').innerText += player.room_id;
              const ep = "https://api.line.me/v2/bot/profile/" + userId;
              fetch(ep, {headers: {Authorization: 'Bearer {{ header }}'}})
                  .then(res => res.json()).then(lineName => register(lineId, lineName))
          } else {
              alert("予期せぬエラーが発生しました。");
              document.getElementById('message').innerText += "予期せぬエラーが発生しました。";
              pushLINE(lineId, "予期せぬエラーが発生しました。")
          }
      };

      liff.init(data=>{
          const lineId = data.context.userId;
          const ep = "https://monopolyapp.herokuapp.com/api/players?format=json&line_id=" + lineId;
          fetch(ep).then(res => res.json()).then(player => loginPlayer(lineId, player[0])).cache(err => {
              alert("ブロファイル情報の取得に失敗しました。" + err);
          });
          liff.closeWindow();
      },err=>{});
  </script>

{% endblock %}
